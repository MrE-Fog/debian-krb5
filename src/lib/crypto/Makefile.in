CFLAGS = $(CCOPTS) $(DEFS) -I$(srcdir)/crc32 -I$(srcdir)/des -I$(srcdir)/md4 \
	-I$(srcdir)/md5
LDFLAGS = -g

##DOSBUILDTOP = ..\..
##DOSLIBNAME=crypto.lib
##DOS!include $(BUILDTOP)\config\windows.in

TST=if test -n "`cat DONE`" ; then

OBJS=	cryptoconf.$(OBJEXT) \
	des_crc.$(OBJEXT) \
	des_md5.$(OBJEXT) \
	raw_des.$(OBJEXT)

SRCS=	$(srcdir)/cryptoconf.c \
	$(srcdir)/des_crc.c \
	$(srcdir)/des_md5.c \
	$(srcdir)/raw_des.c 

all:: all-$(WHAT)

all-unix::

all-windows:: $(OBJS) win_glue.obj

win_glue.obj:: win_glue.c
	$(CC) $(CFLAGS) /c $*.c

libcrypto.lib:: libcrypto.dll
	implib /nologo $@ $(@R).dll
	
libcrypto.dll:: $(LIBNAME) libcrypto.def
	link /co /noe /nologo win_glue,libcrypto.dll,nul,\
		crypto.lib winsock ldllcew libw,libcrypto.def
	rc /p /k $@

libcrypto.a: des/DONE md4/DONE md5/DONE crc32/DONE os/DONE $(OBJS)
	(cd des; $(TST) $(ARADD) ../$@ `cat DONE` ; fi)
	(cd crc32; $(TST) $(ARADD) ../$@ `cat DONE` ; fi)
	(cd md4; $(TST) $(ARADD) ../$@ `cat DONE` ; fi)
	(cd md5; $(TST) $(ARADD) ../$@ `cat DONE` ; fi)
	(cd os; $(TST) $(ARADD) ../$@ `cat DONE` ; fi)
	$(ARADD) $@ $(OBJS)
	$(RANLIB) $@

install:: libcrypto.a
	$(INSTALL_DATA) libcrypto.a $(DESTDIR)$(KRB5_LIBDIR)/libcrypto.a
	$(RANLIB) $(DESTDIR)$(KRB5_LIBDIR)/libcrypto.a

clean:: clean-$(WHAT)
	$(RM) libcrypto.$(LIBEXT) libcrypto.dll libcrypto.bak 

clean-unix::

clean-windows::
	$(RM) crypto.lib crypto.bak

check:: check-$(WHAT)

check-unix::

all-windows::
	cd crc32
	@echo Making in ..\crc32
	-$(MAKE) -$(MFLAGS) LIBCMD=$(LIBCMD)
	cd ..\des
	@echo Making in des
	-$(MAKE) -$(MFLAGS) LIBCMD=$(LIBCMD)
	cd ..\md4
	@echo Making in ..\md4
	-$(MAKE) -$(MFLAGS) LIBCMD=$(LIBCMD)
	cd ..\md5
	@echo Making in ..\md5
	-$(MAKE) -$(MFLAGS) LIBCMD=$(LIBCMD)
	cd ..\os
	@echo Making in ..\os
	-$(MAKE) -$(MFLAGS) LIBCMD=$(LIBCMD)
	cd ..

clean-windows::
	cd crc32
	@echo Making clean in ..\crc32
	-$(MAKE) -$(MFLAGS) clean
	cd ..\des
	@echo Making clean in des
	-$(MAKE) -$(MFLAGS) clean
	cd ..\md4
	@echo Making clean in ..\md4
	-$(MAKE) -$(MFLAGS) clean
	cd ..\md5
	@echo Making clean in ..\md5
	-$(MAKE) -$(MFLAGS) clean
	cd ..\os
	@echo Making clean in ..\os
	-$(MAKE) -$(MFLAGS) clean
	cd ..


check-windows::
	cd crc32
	@echo Making check in ..\crc32
	-$(MAKE) -$(MFLAGS) check
	cd ..\des
	@echo Making check in des
	-$(MAKE) -$(MFLAGS) check
	cd ..\md4
	@echo Making check in ..\md4
	-$(MAKE) -$(MFLAGS) check
	cd ..\md5
	@echo Making check in ..\md5
	-$(MAKE) -$(MFLAGS) check
	cd ..\os
	@echo Making check in ..\os
	-$(MAKE) -$(MFLAGS) check
	cd ..

all-windows:: libcrypto.lib

