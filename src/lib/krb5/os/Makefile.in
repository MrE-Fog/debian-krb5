DBFLAGS=@DBFLAGS@
CFLAGS = $(CCOPTS) $(DEFS) $(DBFLAGS) -DAN_TO_LN_RULES

##DOSBUILDTOP = ..\..\..
##DOSLIBNAME=..\krb5.lib
##DOS!include $(BUILDTOP)\config\windows.in

.c.o:
	$(CC) $(CFLAGS) -c $(srcdir)/$*.c
@SHARED_RULE@

OBJS= \
	an_to_ln.$(OBJEXT)	\
	def_realm.$(OBJEXT)	\
	DNR.$(OBJEXT)	\
	ccdefname.$(OBJEXT)	\
	free_krbhs.$(OBJEXT)	\
	free_hstrl.$(OBJEXT)	\
	full_ipadr.$(OBJEXT)	\
	get_krbhst.$(OBJEXT)	\
	gen_port.$(OBJEXT)	\
	genaddrs.$(OBJEXT)	\
	gen_rname.$(OBJEXT)	\
	gmt_mktime.$(OBJEXT)	\
	hst_realm.$(OBJEXT)	\
	init_os_ctx.$(OBJEXT)	\
	krbfileio.$(OBJEXT)	\
	ktdefname.$(OBJEXT)	\
	kuserok.$(OBJEXT)	\
	mk_faddr.$(OBJEXT)	\
	localaddr.$(OBJEXT)	\
	locate_kdc.$(OBJEXT)	\
	lock_file.$(OBJEXT)	\
	macsock.$(OBJEXT)	\
	net_read.$(OBJEXT)	\
	net_write.$(OBJEXT)	\
	osconfig.$(OBJEXT)	\
	port2ip.$(OBJEXT)	\
	read_msg.$(OBJEXT)	\
	read_pwd.$(OBJEXT)	\
	realm_dom.$(OBJEXT)	\
	sendto_kdc.$(OBJEXT)	\
	sn2princ.$(OBJEXT)	\
	timeofday.$(OBJEXT)	\
	unlck_file.$(OBJEXT)	\
	ustime.$(OBJEXT)	\
	write_msg.$(OBJEXT)

SRCS= \
	$(srcdir)/an_to_ln.c	\
	$(srcdir)/def_realm.c	\
	$(srcdir)/DNR.c	\
	$(srcdir)/ccdefname.c	\
	$(srcdir)/free_krbhs.c	\
	$(srcdir)/free_hstrl.c	\
	$(srcdir)/full_ipadr.c	\
	$(srcdir)/get_krbhst.c	\
	$(srcdir)/gen_port.c	\
	$(srcdir)/genaddrs.c	\
	$(srcdir)/gen_rname.c	\
	$(srcdir)/gmt_mktime.c	\
	$(srcdir)/hst_realm.c	\
	$(srcdir)/init_os_ctx.c	\
	$(srcdir)/krbfileio.c	\
	$(srcdir)/ktdefname.c	\
	$(srcdir)/kuserok.c	\
	$(srcdir)/mk_faddr.c	\
	$(srcdir)/localaddr.c	\
	$(srcdir)/locate_kdc.c	\
	$(srcdir)/lock_file.c	\
	$(srcdir)/macsock.c	\
	$(srcdir)/net_read.c	\
	$(srcdir)/net_write.c	\
	$(srcdir)/osconfig.c	\
	$(srcdir)/read_msg.c	\
	$(srcdir)/read_pwd.c	\
	$(srcdir)/realm_dom.c	\
	$(srcdir)/port2ip.c	\
	$(srcdir)/sendto_kdc.c	\
	$(srcdir)/sn2princ.c	\
	$(srcdir)/timeofday.c	\
	$(srcdir)/unlck_file.c	\
	$(srcdir)/ustime.c	\
	$(srcdir)/write_msg.c

all:: all-$(WHAT)

all-unix:: shared $(OBJS)

all-mac:: $(OBJS)

all-windows:: $(OBJS)

shared:
	mkdir shared

COMERRLIB=$(BUILDTOP)/util/et/libcom_err.a

TEST_PROGS= t_std_conf t_an_to_ln

T_STD_CONF_OBJS= t_std_conf.o def_realm.o get_krbhst.o realm_dom.o \
		hst_realm.o init_os_ctx.o locate_kdc.o $(COMERRLIB) \
		$(TOPLIBD)/libkrb5.a $(TOPLIBD)/libcrypto.a

T_AN_TO_LN_OBJS = t_an_to_ln.o an_to_ln.o $(TOPLIBD)/libkrb5.a	\
		$(TOPLIBD)/libcrypto.a $(COMERRLIB)

t_std_conf: $(T_STD_CONF_OBJS)
	$(CC) -o t_std_conf $(T_STD_CONF_OBJS) $(LIBS)

t_an_to_ln: $(T_AN_TO_LN_OBJS)
	$(CC) -o t_an_to_ln $(T_AN_TO_LN_OBJS) $(LIBS)

check:: check-$(WHAT)

check-unix:: $(TEST_PROGS)
	KRB5_CONFIG=$(srcdir)/td_krb5.conf ; export KRB5_CONFIG ;\
	./t_std_conf  -d -s NEW.DEFAULT.REALM -d \
		-k IGGY.ORG -k DEFAULT_REALM.TST \
		-D DEFAULT_REALM.TST -r bad.idea -r itar.bad.idea \
		-r really.BAD.IDEA. -r clipper.bad.idea -r KeYEsCrOW.BaD.IDea \
		-r pgp.good.idea > test.out
	cmp test.out $(srcdir)/ref_std_conf.out
	$(RM) test.out

clean:: clean-$(WHAT)
	$(RM) $(TEST_PROGS) test.out t_std_conf.o t_an_to_ln.o

clean-unix::
	$(RM) shared/*
clean-mac::
clean-windows::

