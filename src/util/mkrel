#!/bin/sh
: ${repository=/afs/athena.mit.edu/astaff/project/krbdev/.cvsroot}
case $# in
2);;
*)
	echo "usage: $0 release-tag release-dir"
	exit 1
	;;
esac

reltag=$1
reldir=$2

case reldir in
*/*)
	echo "release-dir may not contain slashes."
	exit 1
	;;
*);;
esac

if test ! -d $reldir; then
	mkdir $reldir
fi

cvs -q -d $repository export -r$reltag -d$reldir krb5

echo "Building autoconf"
(cd $reldir/src/util/autoconf
	M4=gm4 ./configure
	make)

echo "Creating configure scripts"
(cd $reldir/src;util/reconf)

echo "Cleaning src/util/autoconf"
(cd $reldir/src/util/autoconf;make distclean)

echo "Nuking unneeded files"
find $reldir \( -name TODO -o -name todo -o -name .cvsignore \
	-o -name BADSYMS -o -name .Sanitize \) -print \
	| xargs rm -f

echo "Generating tarfiles"
gtar --exclude $reldir/src/lib/crypto \
	--exclude $reldir/src/lib/des425 \
	-zcf ${reldir}.src.tar.gz $reldir

gtar zcf ${reldir}.crypto.tar.gz \
	$reldir/src/lib/crypto \
	$reldir/src/lib/des425

gtar zcf ${reldir}.doc.tar.gz $reldir/doc $reldir/README

exit 0
