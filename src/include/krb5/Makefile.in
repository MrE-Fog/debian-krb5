KDB5DIR = $(KRB5ROOT)
KRB5SRVTABDIR = /etc
KRB5RCTMPDIR= @KRB5_RCTMPDIR@

##DOSBUILDTOP = ..\..
##DOS!include $(BUILDTOP)\config\windows.in

KRB5_HEADERS = adm.h adm_proto.h asn1.h ext-proto.h k5-config.h k5-errors.h \
		kdb.h kdb_dbm.h libos.h los-proto.h mit-des.h preauth.h \
		rsa-md5.h sysincl.h winsock.h

# these are installed here for the build from lib/krb5/error_tables but 
# also need to be in the installed tree
ET_HEADERS = adm_err.h asn1_err.h kdb5_err.h krb5_err.h
BUILT_HEADERS = autoconf.h osconf.h

all:: all-$(WHAT)

all-unix:: $(BUILT_HEADERS)
all-mac:: $(BUILT_HEADERS)
all-windows:
	copy stock\osconf.h osconf.h
	echo /* not used in windows */ > autoconf.h

includes:: autoconf.h

# Run a header through a preprocessor to generate an architecture/environment
# specific header file.  note that unifdef's exit status will normally be 1,
# indicating some adjustment of the file took place.

autoconf.h: $(srcdir)/autoconf.h.in config.status
	$(SHELL) config.status

clean::
	$(RM) autoconf.h

depend::

install:: $(KRB5_HEADERS) osconf.h autoconf.h 
	@set -x; for f in $(KRB5_HEADERS) ; \
	do if cmp -s $$f $(DESTDIR)$(KRB5_INCDIR)/krb5/$$f; \
	then true; else \
		$(RM) $(DESTDIR)$(KRB5_INCDIR)/krb5/$$f; \
		cp $(srcdir)/$$f $(DESTDIR)$(KRB5_INCDIR)/krb5/$$f ; \
	fi; done
	@set -x; for f in osconf.h autoconf.h $(ET_HEADERS); \
	do if cmp -s $$f $(DESTDIR)$(KRB5_INCDIR)/krb5/$$f; \
	then true; else \
		$(RM) $(DESTDIR)$(KRB5_INCDIR)/krb5/$$f; \
		cp $$f $(DESTDIR)$(KRB5_INCDIR)/krb5/$$f ; \
	fi; done

PROCESS_REPLACE = -e "s+@KRB5ROOT+$(KRB5ROOT)+" \
		  -e "s+@KDB5DIR+$(KDB5DIR)+" \
		  -e "s+@KRB5RCTMPDIR+$(KRB5RCTMPDIR)+" \
		  -e "s+@KRB5SRVTABDIR+$(KRB5SRVTABDIR)+" 

OSCONFSRC = $(srcdir)/stock/osconf.h

osconf.h: $(OSCONFSRC)
	cat $(OSCONFSRC) | sed $(PROCESS_REPLACE) > osconf.new
	@if cmp -s osconf.new osconf.h ; then :; \
	else (set -x; $(RM) osconf.h ; $(CP) osconf.new osconf.h; $(RM) osconf.new) fi

clean:: clean-$(WHAT)
	$(RM) osconf.new $(BUILT_HEADERS)

clean-unix::
	$(RM) $(ET_HEADERS)
clean-mac::
clean-windows::
