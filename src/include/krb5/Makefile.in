BUILDTOP=@BUILDTOP@
srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
CCOPTS = @CCOPTS@
LEX = @LEX@
LEXLIB = @LEXLIB@

KRB5ROOT = @KRB5ROOT@
KDB5DIR = $(KRB5ROOT)
KRB5SRVTABDIR = /etc

KRB5MANROOT = $(KRB5ROOT)/man
ADMIN_BINDIR = $(KRB5ROOT)/admin
SERVER_BINDIR = $(KRB5ROOT)/sbin
CLIENT_BINDIR = $(KRB5ROOT)/bin
ADMIN_MANDIR = $(KRB5MANROOT)/man8
SERVER_MANDIR = $(KRB5MANROOT)/man8
CLIENT_MANDIR = $(KRB5MANROOT)/man1
FILE_MANDIR = $(KRB5MANROOT)/man5
KRB5_LIBDIR = $(KRB5ROOT)/lib
KRB5_INCDIR = $(KRB5ROOT)/include
KRB5_INCSUBDIRS = \
	$(KRB5_INCDIR)/krb5 \
	$(KRB5_INCDIR)/asn.1 \
	$(KRB5_INCDIR)/kerberosIV

RM = rm -f

CP = cp

KRB5_HEADERS = asn1.h base-defs.h ccache.h crc-32.h encryption.h \
		error_def.h errors.h ext-proto.h fieldbits.h \
		free.h func-proto.h hostaddr.h kdb.h kdb_dbm.h \
		keytab.h krb5.h libos.h los-proto.h macros.h mit-des.h \
		narrow.h proto.h rcache.h rsa-md4.h safepriv.h \
		sysincl.h widen.h wordsize.h

all:: autoconf.h osconf.h config.h

includes:: autoconf.h

# Run a header through a preprocessor to generate an architecture/environment
# specific header file.  note that unifdef's exit status will normally be 1,
# indicating some adjustment of the file took place.

autoconf.h: $(srcdir)/autoconf.h.in config.status
	$(SHELL) config.status

clean::
	$(RM) autoconf.h

depend::

KRB5ROOT = @KRB5ROOT@

KRB5_INCDIR = $(KRB5ROOT)/include

install:: $(KRB5_HEADERS) config.h osconf.h autoconf.h
	@set -x; for f in $(KRB5_HEADERS) config.h osconf.h ; \
	do cp $$f $(KRB5_INCDIR)/krb5/$$f ; \
	done

PROCESS_REPLACE = -e "s+@KRB5ROOT+$(KRB5ROOT)+" \
		  -e "s+@KDB5DIR+$(KDB5DIR)+" \
		  -e "s+@KRB5SRVTABDIR+${KRB5SRVTABDIR}+" \
		  -e "/UnifdefRan/,/SPLIT-HERE/d"

OSCONFSRC = $(srcdir)/stock/osauto.h $(srcdir)/stock/osconf.h

osconf.h: $(OSCONFSRC)
	cat $(OSCONFSRC) | sed $(PROCESS_REPLACE) > osconf.new
	if cmp -s osconf.new osconf.h ; then true; \
	else $(RM) osconf.h ; $(CP) osconf.new osconf.h ; fi

CONF_REPLACE = -e "/UnifdefRan/,/SPLIT-HERE/d"

CONFSRC = $(srcdir)/stock/confauto.h $(srcdir)/stock/config.h

config.h: $(CONFSRC)
	cat $(CONFSRC) | sed $(CONF_REPLACE) > config.new
	if cmp -s config.new config.h ; then true; \
	else $(RM) config.h ; $(CP) config.new config.h ; fi

clean::
	$(RM) config.h config.new osconf.h osconf.new
